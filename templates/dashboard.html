{% extends "layout.html" %}
{% block title %}Dashboard | Data Vault System{% endblock %}
{% block content %}

<div class="container-fluid py-4">

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for c, m in messages %}
      <div class="alert alert-{{ c }} alert-dismissible fade show text-center">
        {{ m }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endwith %}

  <!-- Header -->
  <h2 class="fw-bold text-primary text-center mb-4">
    Welcome, {{ username }}!
  </h2>

  <!-- Stats -->
  <div class="row g-4 mb-4 text-center">

    <div class="col-md-3 col-sm-6">
      <div class="stats-card p-3 shadow-sm rounded-4">
        <h6 class="text-muted">Total Entries</h6>
        <h3 class="fw-bold text-primary">{{ total_entries }}</h3>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="stats-card p-3 shadow-sm rounded-4">
        <h6 class="text-muted">Total Amount</h6>
        <h3 class="fw-bold text-success">
          ₹{{ "%.2f"|format(total_amount) }}
        </h3>
      </div>
    </div>

    <div class="col-md-2 col-sm-4">
      <div class="stats-card p-3 shadow-sm rounded-4">
        <h6 class="text-muted">Male</h6>
        <h3 class="fw-bold text-info">{{ male_count }}</h3>
      </div>
    </div>

    <div class="col-md-2 col-sm-4">
      <div class="stats-card p-3 shadow-sm rounded-4">
        <h6 class="text-muted">Female</h6>
        <h3 class="fw-bold text-danger">{{ female_count }}</h3>
      </div>
    </div>

    <div class="col-md-2 col-sm-4">
      <div class="stats-card p-3 shadow-sm rounded-4">
        <h6 class="text-muted">Other</h6>
        <h3 class="fw-bold text-secondary">{{ other_count }}</h3>
      </div>
    </div>

  </div>

  <div class="row g-4">

    <!-- Add Entry Form -->
    <div class="col-lg-4">
      <div class="card p-4 shadow rounded-4">
        <h5 class="fw-bold text-primary text-center mb-3">
          Add New Entry
        </h5>

        <form method="POST" action="{{ url_for('add_entry') }}">

          <label class="fw-semibold">Full Name</label>
          <input type="text" name="name" class="form-control mb-3" required>

          <label class="fw-semibold">Gender</label>
          <select name="gender" class="form-select mb-3" required>
            <option value="">Select gender</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>

          <label class="fw-semibold">Amount</label>
          <input type="number" name="amount" step="any"
                 class="form-control mb-3" required>

          <label class="fw-semibold">Date</label>
          <input type="date" name="date"
                 class="form-control mb-3" required>

          <button type="submit"
                  class="btn btn-primary w-100 fw-semibold">
            Add Entry
          </button>

        </form>
      </div>
    </div>

    <!-- Entries Table -->
    <div class="col-lg-8">

      <div class="card p-4 shadow rounded-4">

        <div class="d-flex justify-content-between mb-3">
          <h5 class="fw-bold text-primary">Entries</h5>

          <div class="d-flex gap-2">
            <a href="{{ url_for('export', fmt='csv') }}"
               class="btn btn-outline-primary btn-sm">CSV</a>

            <a href="{{ url_for('export', fmt='excel') }}"
               class="btn btn-outline-success btn-sm">Excel</a>

            <a href="{{ url_for('export', fmt='pdf') }}"
               class="btn btn-outline-danger btn-sm">PDF</a>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-primary">
              <tr class="text-center">
                {% if session.get('is_admin') %}
                <th>User</th>
                {% endif %}
                <th>Name</th>
                <th>Gender</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              {% for entry in entries %}
              <tr class="text-center">

                {% if session.get('is_admin') %}
                <td>{{ entry['owner_name'] }}</td>
                {% endif %}

                <td>{{ entry['name'] }}</td>
                <td>{{ entry['gender'] }}</td>
                <td>₹{{ "%.2f"|format(entry['amount'] or 0) }}</td>
                <td>{{ entry['date'] }}</td>

                <td>
                  <a href="{{ url_for('view_entry', entry_id=entry['id']) }}"
                     class="btn btn-info btn-sm text-white">View</a>

                  <a href="{{ url_for('edit_entry', entry_id=entry['id']) }}"
                     class="btn btn-warning btn-sm">Edit</a>

                  <a href="{{ url_for('delete_entry', entry_id=entry['id']) }}"
                     onclick="return confirm('Delete this entry?')"
                     class="btn btn-danger btn-sm">Delete</a>
                </td>

              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>

      <!-- Gender Analytics -->
      <div class="card shadow border-0 p-4 rounded-4 mt-4">
        <h5 class="fw-bold text-primary mb-3">
          Gender Analytics
        </h5>
        <canvas id="genderChart" height="120"></canvas>
      </div>

    </div>

  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const genderLabels = ['Male', 'Female', 'Other'];
const genderCounts = [
  {{ male_count }},
  {{ female_count }},
  {{ other_count }}
];

new Chart(document.getElementById('genderChart'), {
  type: 'doughnut',
  data: {
    labels: genderLabels,
    datasets: [{
      data: genderCounts,
      backgroundColor: ['#0984e3', '#e17055', '#6c5ce7'],
      borderWidth: 1
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'bottom' },
      title: {
        display: true,
        text: 'Entries by Gender'
      }
    }
  }
});
</script>

{% endblock %}
