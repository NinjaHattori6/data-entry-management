{% extends "layout.html" %}
{% block title %}Register | Data Vault{% endblock %}
{% block content %}

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-5">
      <div class="card shadow-lg p-4 border-0 rounded-4">

        <h3 class="text-center text-primary mb-4 fw-bold">
          <i class="fa-solid fa-user-plus me-2"></i> Create Account
        </h3>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show text-center fw-semibold">
              {{ message }}
              <button class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endwith %}

        <form method="POST" action="{{ url_for('register') }}" id="registerForm">

          <div class="mb-3">
            <label class="form-label fw-semibold">Username</label>
            <input type="text" name="username" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Password</label>

            <div class="input-group">
              <input type="password" id="password" name="password"
                     class="form-control"
                     minlength="6" required
                     data-bs-toggle="tooltip"
                     title="Use uppercase, lowercase, numbers and symbols">

              <span class="input-group-text" id="togglePassword" style="cursor:pointer;">
                <i class="fa-solid fa-eye"></i>
              </span>
            </div>

            <small id="strengthText" class="fw-bold mt-1 d-block"></small>

            <div class="progress mt-1" style="height:6px;">
              <div id="strengthBar" class="progress-bar" style="width:0%"></div>
            </div>

            <ul class="small mt-2">
              <li id="ruleLength" class="text-danger">At least 6 characters</li>
              <li id="ruleUpper" class="text-danger">Uppercase letter (A-Z)</li>
              <li id="ruleLower" class="text-danger">Lowercase letter (a-z)</li>
              <li id="ruleNumber" class="text-danger">Number (0-9)</li>
              <li id="ruleSymbol" class="text-danger">Symbol (!@#$%)</li>
            </ul>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Confirm Password</label>
            <div class="input-group">
              <input type="password" id="confirm_password" class="form-control" required>
              <span class="input-group-text" id="toggleConfirmPassword" style="cursor:pointer;">
                <i class="fa-solid fa-eye"></i>
              </span>
            </div>
          </div>

          <button class="btn btn-primary w-100 fw-semibold mt-2">Register</button>
        </form>

      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* TOOLTIP (SAFE) */
  if (typeof bootstrap !== "undefined") {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
      new bootstrap.Tooltip(el);
    });
  }

  const pwd = document.getElementById("password");
  const confirmPwd = document.getElementById("confirm_password");
  const bar = document.getElementById("strengthBar");
  const text = document.getElementById("strengthText");

  const rules = {
    length: document.getElementById("ruleLength"),
    upper: document.getElementById("ruleUpper"),
    lower: document.getElementById("ruleLower"),
    number: document.getElementById("ruleNumber"),
    symbol: document.getElementById("ruleSymbol")
  };

  pwd.addEventListener("input", () => {
    const v = pwd.value;
    let score = 0;

    const checks = {
      length: v.length >= 6,
      upper: /[A-Z]/.test(v),
      lower: /[a-z]/.test(v),
      number: /[0-9]/.test(v),
      symbol: /[^A-Za-z0-9]/.test(v)
    };

    Object.keys(checks).forEach(k => {
      rules[k].classList.toggle("text-success", checks[k]);
      rules[k].classList.toggle("text-danger", !checks[k]);
      if (checks[k]) score++;
    });

    bar.className = "progress-bar";

    if (score <= 2) {
      bar.style.width = "30%";
      bar.classList.add("bg-danger");
      text.textContent = "Weak Password";
    } else if (score === 3) {
      bar.style.width = "60%";
      bar.classList.add("bg-warning");
      text.textContent = "Medium Strength";
    } else {
      bar.style.width = "100%";
      bar.classList.add("bg-success");
      text.textContent = "Strong Password";
    }
  });

  document.getElementById("registerForm").addEventListener("submit", e => {
    if (pwd.value !== confirmPwd.value) {
      e.preventDefault();
      alert("Passwords do not match!");
    }
  });

  const toggle = (id, btn) => {
    const i = document.getElementById(id);
    const icon = btn.querySelector("i");
    i.type = i.type === "password" ? "text" : "password";
    icon.classList.toggle("fa-eye");
    icon.classList.toggle("fa-eye-slash");
  };

  document.getElementById("togglePassword").onclick =
    () => toggle("password", togglePassword);
  document.getElementById("toggleConfirmPassword").onclick =
    () => toggle("confirm_password", toggleConfirmPassword);
});
</script>

{% endblock %}
